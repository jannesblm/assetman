<template>
  <div class="modal-content">
    <div v-if="! busy"
         :class="[{'bg-danger': vulnerabilities.length > 0, 'bg-success': vulnerabilities.length === 0}, 'modal-status']"></div>
    <div class="modal-header">
      <h5 class="modal-title">Searching NVD for Vulnerabilities</h5>
    </div>
    <div v-if="busy">
      <div class="modal-body">
        <p class="mb-4">Searching for Keyword "{{ keyword }}"</p>
        <div class="progress">
          <div class="progress-bar progress-bar-indeterminate bg-green"></div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-success form-control" type="button" @click="abort">Abort</button>
      </div>
    </div>
    <div v-else>
      <div class="modal-body text-muted">
        <p v-if="vulnerabilities.length > 0">NVD has identified {{ vulnerabilities.length }} vulnerabilitie(s) for the
          query
          "{{ keyword }}". Applying to following devices:</p>
        <p v-else>NVD has not returned any vulnerabilities for the query "{{ keyword }}".</p>
        <ul v-if="vulnerabilities.length > 0">
          <li v-for="(title, index) in titles" :key="index">{{ title }}</li>
        </ul>
        <p v-if="vulnerabilities.length > 0">These CVEs were found:</p>
        <ul>
          <li v-for="(cve, index) in vulnerabilities" :key="index">
            <a class="link-info cursor-pointer" @click="openCve(cve)"><i class="ti ti-external-link mr-3"></i> {{ cve }}</a>
          </li>
        </ul>
        <button
            :class="[{'btn-danger': vulnerabilities.length > 0, 'btn-success': vulnerabilities.length === 0}, 'btn', 'form-control']"
            type="button" @click="$emit('close', false)">Dismiss
        </button>
      </div>
    </div>
  </div>
</template>

<script>

import {Cpe, Report} from "@/models";

export default {
  name: "VulnerabilityModal",

  props: {
    keyword: {
      type: String,
      required: true,
    },
    assetId: {
      type: Number,
      required: true,
    }
  },

  data() {
    return {
      busy: true,
      cpes: [],
      interval: -1,
    }
  },

  methods: {
    async loadCpes() {
      await window.go.vulnerability.service.SearchCpeByKeyword(this.keyword)

      this.interval = setInterval(async () => {
        let lastCpe = (await window.go.vulnerability.service.GetLastCpe()).map(v => new Cpe(v))

        if (lastCpe.length > 0) {
          clearInterval(this.interval)
          this.cpes = lastCpe

          if (this.vulnerabilities.length > 0) {
            await window.go.sqlite.reportRepository.Save(new Report({
              AssetID: this.assetId,
              ReportedAt: Date.now(),
              Cves: this.vulnerabilities.map(v => { return {CVE: v} })
            }))
          }

          this.busy = false
          this.$emit("message", "searchDone")
        }
      }, 500)
    },

    openCve(cve) {
      window.open("https://nvd.nist.gov/vuln/detail/" + cve);
    },

    abort() {
      if (!this.busy || this.interval === -1) {
        return
      }

      clearInterval(this.interval)
      this.interval = -1

      this.$emit("close", 0)
    }
  },

  computed: {
    titles: function () {
      return this.cpes.map(({Titles: [{title}]}) => title)
    },

    vulnerabilities: function () {
      if (this.cpes.length === 0) {
        return []
      }

      return this.cpes.map(({vulnerabilities: [v]}) => v).filter(s => s !== "")
    }
  },

  mounted() {
    this.loadCpes()
  }
}
</script>

<style scoped>
li {
  list-style-type: none;
}
</style>