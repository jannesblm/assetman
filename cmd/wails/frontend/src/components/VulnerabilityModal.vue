<template>
  <div class="modal-content">
    <div v-if="! busy"
         :class="[{'bg-success': vulnerabilities.length === 0, 'bg-danger': vulnerabilities.length > 0}, 'modal-status']"></div>
    <div class="modal-header">
      <h5 class="modal-title">Searching NVD for Vulnerabilities</h5>
    </div>
    <div v-if="busy">
      <div class="modal-body">
        <p class="mb-4">Searching for Keyword "{{ keyword }}"</p>
        <div class="progress">
          <div class="progress-bar progress-bar-indeterminate bg-green"></div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-success form-control" type="button">Abort</button>
      </div>
    </div>
    <div v-else>
      <div class="modal-body text-muted">
        <p v-if="vulnerabilities.length > 0">NVD has identified {{ vulnerabilities.length }} vulnerabilities for the
          query
          "{{ keyword }}". Applying to following devices:</p>
        <p v-else>NVD has not returned any vulnerabilities for the query "{{ keyword }}".</p>
        <ul v-if="vulnerabilities.length > 0">
          <li v-for="(title, index) in titles" :key="index">{{ title }}</li>
        </ul>
        <p v-if="vulnerabilities.length > 0">These CVEs were found:</p>
        <ul>
          <li v-for="(cve, index) in vulnerabilities" :key="index">
            <a class="link-info cursor-pointer" @click="openCve(cve)"><i class="ti ti-external-link mr-3"></i> {{ cve }}</a>
          </li>
        </ul>
        <button class="btn btn-light form-control" type="button" @click="$emit('close', false)">Dismiss</button>
      </div>
    </div>
  </div>
</template>

<script>

import {Cpe} from "@/models";

export default {
  name: "VulnerabilityModal",

  props: {
    keyword: {
      type: String,
      required: true,
    }
  },

  data() {
    return {
      busy: true,
      cpes: [],
    }
  },

  methods: {
    async loadCpes() {
      await window.go.vulnerability.service.SearchCpeByKeyword(this.keyword)

      const i = setInterval(async () => {
        let lastCpe = (await window.go.vulnerability.service.GetLastCpe()).map(v => new Cpe(v))

        if (lastCpe.length > 0) {
          clearInterval(i)

          this.cpes = lastCpe
          this.busy = false
        }
      }, 50)
    },

    openCve(cve) {
      window.open("https://nvd.nist.gov/vuln/detail/" + cve);
    }
  },

  computed: {
    titles: function () {
      return this.cpes.map(({Titles: [{title}]}) => title)
    },

    vulnerabilities: function () {
      return this.cpes.map(({vulnerabilities: [v]}) => v).filter(s => s !== "")
    }
  },

  mounted() {
    this.loadCpes()
  }
}
</script>

<style scoped>
  li {
    list-style-type: none;
  }

  .mr-3 {
    margin-right: .5rem;
  }
</style>